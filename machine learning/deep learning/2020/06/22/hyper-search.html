<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <title>Super-charge hyper-paramater search with Optuna | 
  sambaiga
</title>
  

  
  <meta name="description" content="
  
">
  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Super-charge hyper-paramater search with Optuna | sambaiga</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Super-charge hyper-paramater search with Optuna" />
<meta name="author" content="Anthony Faustine" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learn how to perform hyper-paramater search using Optuna" />
<meta property="og:description" content="Learn how to perform hyper-paramater search using Optuna" />
<link rel="canonical" href="https://sambaiga.github.io/sambaiga/machine%20learning/deep%20learning/2020/06/22/hyper-search.html" />
<meta property="og:url" content="https://sambaiga.github.io/sambaiga/machine%20learning/deep%20learning/2020/06/22/hyper-search.html" />
<meta property="og:site_name" content="sambaiga" />
<meta property="og:image" content="https://sambaiga.github.io/sambaiga/images/post/search.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-22T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2020-06-22T00:00:00-05:00","author":{"@type":"Person","name":"Anthony Faustine"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sambaiga.github.io/sambaiga/machine%20learning/deep%20learning/2020/06/22/hyper-search.html"},"description":"Learn how to perform hyper-paramater search using Optuna","image":"https://sambaiga.github.io/sambaiga/images/post/search.jpg","@type":"BlogPosting","url":"https://sambaiga.github.io/sambaiga/machine%20learning/deep%20learning/2020/06/22/hyper-search.html","headline":"Super-charge hyper-paramater search with Optuna","dateModified":"2020-06-22T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/sambaiga/assets/css/style.css">
  <link rel="stylesheet" href="/sambaiga/assets/css/main.css">
  <link rel="canonical" href="https://sambaiga.github.io/sambaiga/machine%20learning/deep%20learning/2020/06/22/hyper-search.html"><link type="application/atom+xml" rel="alternate" href="https://sambaiga.github.io/sambaiga/feed.xml" title="sambaiga" />

  

  

  

  <link rel="shortcut icon" type="image/x-icon" href="/sambaiga/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Super-charge hyper-paramater search with Optuna | sambaiga</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Super-charge hyper-paramater search with Optuna" />
<meta name="author" content="Anthony Faustine" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learn how to perform hyper-paramater search using Optuna" />
<meta property="og:description" content="Learn how to perform hyper-paramater search using Optuna" />
<link rel="canonical" href="https://sambaiga.github.io/sambaiga/machine%20learning/deep%20learning/2020/06/22/hyper-search.html" />
<meta property="og:url" content="https://sambaiga.github.io/sambaiga/machine%20learning/deep%20learning/2020/06/22/hyper-search.html" />
<meta property="og:site_name" content="sambaiga" />
<meta property="og:image" content="https://sambaiga.github.io/sambaiga/images/post/search.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-22T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2020-06-22T00:00:00-05:00","author":{"@type":"Person","name":"Anthony Faustine"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sambaiga.github.io/sambaiga/machine%20learning/deep%20learning/2020/06/22/hyper-search.html"},"description":"Learn how to perform hyper-paramater search using Optuna","image":"https://sambaiga.github.io/sambaiga/images/post/search.jpg","@type":"BlogPosting","url":"https://sambaiga.github.io/sambaiga/machine%20learning/deep%20learning/2020/06/22/hyper-search.html","headline":"Super-charge hyper-paramater search with Optuna","dateModified":"2020-06-22T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://sambaiga.github.io/sambaiga/feed.xml" title="sambaiga" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    // remove paragraph tags in rendered toc (happens from notebooks)
    var toctags = document.querySelectorAll(".toc-entry")
    toctags.forEach(e => (e.firstElementChild.innerText = e.firstElementChild.innerText.replace('¶', '')))
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/sambaiga/">sambaiga</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/sambaiga/about/">About</a><a class="page-link" href="/sambaiga/project/">Projects</a><a class="page-link" href="/sambaiga/resources.html">Resources</a><a class="page-link" href="/sambaiga/categories/">Tags</a><a class="page-link" href="/sambaiga/talks/">Talk</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <div class="wrapper">
    <h1 class="post-title p-name" itemprop="name headline">Super-charge hyper-paramater search with Optuna</h1><p class="page-description">Learn how to perform hyper-paramater search using Optuna</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-06-22T00:00:00-05:00" itemprop="datePublished">
        Jun 22, 2020
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Anthony Faustine</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      10 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/sambaiga/categories/#Machine learning">Machine learning</a>
        &nbsp;
      
        <a class="category-tags-link" href="/sambaiga/categories/#Deep learning">Deep learning</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/sambaiga/sambaiga/tree/master/_notebooks/2020-06-22-hyper-search.ipynb" role="button">
<img class="notebook-badge-image" src="/sambaiga/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div><div class="px-2">
    <a href="https://colab.research.google.com/github/sambaiga/sambaiga/blob/master/_notebooks/2020-06-22-hyper-search.ipynb">
        <img class="notebook-badge-image" src="/sambaiga/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#Introduction">Introduction </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Optuna">Optuna </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Hyper-param-search-for--deep-neural-net">Hyper-param search for  deep neural net </a>
<ul>
<li class="toc-entry toc-h3"><a href="#MLP-model">MLP model </a></li>
<li class="toc-entry toc-h3"><a href="#Pytorch-lightning-model">Pytorch lightning model </a></li>
<li class="toc-entry toc-h3"><a href="#Define-objective-function">Define objective function </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-06-22-hyper-search.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">
<a class="anchor" href="#Introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction<a class="anchor-link" href="#Introduction"> </a>
</h2>
<p>Training machine learning sometimes involves various hyperparameter settings. Performing a hyperparameter search is an integral element in building machine learning models. It consists of attuning different sets of parameters to find the best settings for excellent model performance. It should be remarked that deep neural networks can involve many hyperparameter settings. Getting the best set parameters for such a high dimensional space might a challenging task. Opportunely, different strategies and tools can be used to simplify the process. This post will guide you on how to use Optuna for a hyper-parameter search using <a href="https://pytorch.org/">PyTorch</a> and <a href="https://github.com/PyTorchLightning/pytorch-lightning">PyTorch lightning</a> framework.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To install these packages</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">optuna</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">torch</span> <span class="n">torchvision</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">pytorch</span><span class="o">-</span><span class="n">lightning</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Optuna">
<a class="anchor" href="#Optuna" aria-hidden="true"><span class="octicon octicon-link"></span></a>Optuna<a class="anchor-link" href="#Optuna"> </a>
</h3>
<p><a href="https://optuna.org/">Optuna</a> is an open-source hyperparameter optimization framework.  It automates the process of searching for optimal hyperparameter using Python conditionals, loops, and syntax. The optuna library offers efficiently hyper-parameter search in large spaces while pruning unpromising trials for faster results. Using optuna it is possible to parallelize hyperparameter searches over multiple threads or processes without modifying code.
The optuna optimization problem consists of three main building blocks; <strong>objective function</strong>, <strong>trial</strong> and <strong>study</strong>. Let consider a simple optimisation problem: <em>Suppose a rectangular garden is to be constructed using a rock wall as one side of the garden and wire fencing for the other three sides as shown in figure belwo. Given  500m of wire fencing, determine the dimensions that would create a garden of maximum area. What is the maximum area?</em></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let  $x$ denote the length of the side of the garden perpendicular to the rock wall and  $y$  denote the length of the side parallel to the rock wall. Then the area of the garden $A= x \cdot y$. We want to find the maximum possible area subject to the constraint that the total fencing is 500m. The total amount of fencing used will be  $2x+y$.  Therefore, the constraint equation is 
\begin{align}
500 &amp; = 2x +y \\
y  &amp; = 500-2x\\
A(x) &amp;= x \cdot (500-2x) =  500x - 2x^2
\end{align}</p>
<p>From equation above, $A(x) = 500x - 2x^2$ is an <strong>objective function</strong>, the function to be optimized. To maximize this function, we need to determine optimization constraints. We know that to construct a rectangular garden, we certainly need the lengths of both sides to be positive $y&gt;0$, and  $x&gt;0$. Since $500  = 2x +y$ and $y&gt;0$ then $x&lt;250$. Therefore, we will try to determine the maximum value of A(x) for x over the open interval (0,50).</p>
<p>Optuna <a href="https://optuna.readthedocs.io/en/stable/reference/trial.html"><strong>trial</strong></a>  corresponds to a single execution of the <strong>objective function</strong> and is internally instantiated upon each invocation of the function. To obtain the parameters for each trial within a provided <em>contsrtainst</em> the <a href="https://optuna.readthedocs.io/en/stable/reference/trial.html"><strong>suggest</strong></a> is used.</p>
<div class="highlight"><pre><span></span><span class="n">trial</span><span class="o">.</span><span class="n">suggest_uniform</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
</pre></div>
<p>We can now code the objective function that be optimized for our problem.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">gardent_area</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_uniform</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">500</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once the objective function has been defined, the <a href=""><strong>study object</strong></a> is used to start the optimization. Thus optuna <strong>trial</strong> is a single call of the objective function whereas <strong>study</strong> is  an optimization session, which is a set of trials. We can now create a study and start the optimisation process.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">optuna</span>
<span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">study_name</span><span class="o">=</span><span class="s2">"garden"</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">"maximize"</span><span class="p">)</span>
<span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">gardent_area</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre><span class="ansi-green-fg">[I 2020-06-21 09:21:59,460]</span> Finished trial#0 with value: 30192.883232182987 with parameters: {'x': 102.00960235427611}. Best is trial#0 with value: 30192.883232182987.
<span class="ansi-green-fg">[I 2020-06-21 09:21:59,525]</span> Finished trial#1 with value: 11665.34358605057 with parameters: {'x': 223.956193373506}. Best is trial#0 with value: 30192.883232182987.
<span class="ansi-green-fg">[I 2020-06-21 09:21:59,587]</span> Finished trial#2 with value: 29967.46342643536 with parameters: {'x': 150.32327559345987}. Best is trial#0 with value: 30192.883232182987.
<span class="ansi-green-fg">[I 2020-06-21 09:21:59,670]</span> Finished trial#3 with value: 30132.313125645393 with parameters: {'x': 148.63986965229094}. Best is trial#0 with value: 30192.883232182987.
<span class="ansi-green-fg">[I 2020-06-21 09:21:59,731]</span> Finished trial#4 with value: 26891.79238720805 with parameters: {'x': 171.68087195410956}. Best is trial#0 with value: 30192.883232182987.
<span class="ansi-green-fg">[I 2020-06-21 09:21:59,791]</span> Finished trial#5 with value: 25917.313521440778 with parameters: {'x': 73.36335371773636}. Best is trial#0 with value: 30192.883232182987.
<span class="ansi-green-fg">[I 2020-06-21 09:21:59,848]</span> Finished trial#6 with value: 30918.40566786742 with parameters: {'x': 112.12377516248301}. Best is trial#6 with value: 30918.40566786742.
<span class="ansi-green-fg">[I 2020-06-21 09:21:59,937]</span> Finished trial#7 with value: 30464.28049218819 with parameters: {'x': 105.17930995384103}. Best is trial#6 with value: 30918.40566786742.
<span class="ansi-green-fg">[I 2020-06-21 09:21:59,984]</span> Finished trial#8 with value: 10359.360983968212 with parameters: {'x': 22.79765409729631}. Best is trial#6 with value: 30918.40566786742.
<span class="ansi-green-fg">[I 2020-06-21 09:22:00,050]</span> Finished trial#9 with value: 30362.939942726232 with parameters: {'x': 103.9398473738464}. Best is trial#6 with value: 30918.40566786742.
<span class="ansi-green-fg">[I 2020-06-21 09:22:00,120]</span> Finished trial#10 with value: 1948.2286498883193 with parameters: {'x': 3.959156996260802}. Best is trial#6 with value: 30918.40566786742.
<span class="ansi-green-fg">[I 2020-06-21 09:22:00,195]</span> Finished trial#11 with value: 22169.977206566673 with parameters: {'x': 57.62039331729025}. Best is trial#6 with value: 30918.40566786742.
<span class="ansi-green-fg">[I 2020-06-21 09:22:00,259]</span> Finished trial#12 with value: 22518.027165398147 with parameters: {'x': 191.07561136532092}. Best is trial#6 with value: 30918.40566786742.
<span class="ansi-green-fg">[I 2020-06-21 09:22:00,323]</span> Finished trial#13 with value: 22596.755353896893 with parameters: {'x': 59.22293467285459}. Best is trial#6 with value: 30918.40566786742.
<span class="ansi-green-fg">[I 2020-06-21 09:22:00,376]</span> Finished trial#14 with value: 31135.23373151821 with parameters: {'x': 117.42483437534882}. Best is trial#14 with value: 31135.23373151821.
<span class="ansi-green-fg">[I 2020-06-21 09:22:00,413]</span> Finished trial#15 with value: 30565.092057209593 with parameters: {'x': 143.50551191929594}. Best is trial#14 with value: 31135.23373151821.
<span class="ansi-green-fg">[I 2020-06-21 09:22:00,476]</span> Finished trial#16 with value: 18976.533391319535 with parameters: {'x': 203.33730467880696}. Best is trial#14 with value: 31135.23373151821.
<span class="ansi-green-fg">[I 2020-06-21 09:22:00,553]</span> Finished trial#17 with value: 31248.552104334674 with parameters: {'x': 125.85085124003193}. Best is trial#17 with value: 31248.552104334674.
<span class="ansi-green-fg">[I 2020-06-21 09:22:00,590]</span> Finished trial#18 with value: 26334.324397390694 with parameters: {'x': 75.42341478777855}. Best is trial#17 with value: 31248.552104334674.
<span class="ansi-green-fg">[I 2020-06-21 09:22:00,648]</span> Finished trial#19 with value: 31134.297753574312 with parameters: {'x': 132.60599258564204}. Best is trial#17 with value: 31248.552104334674.
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once the study is completed you can get the best parameters as follows</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">study</span><span class="o">.</span><span class="n">best_params</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'x': 125.85085124003193}</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">study</span><span class="o">.</span><span class="n">best_value</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>31248.552104334674</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Hyper-param-search-for--deep-neural-net">
<a class="anchor" href="#Hyper-param-search-for--deep-neural-net" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hyper-param search for  deep neural net<a class="anchor-link" href="#Hyper-param-search-for--deep-neural-net"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="MLP-model">
<a class="anchor" href="#MLP-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>MLP model<a class="anchor-link" href="#MLP-model"> </a>
</h3>
<p>Suppose we want to build MLP classifier to recognize handwritten digits using the MNIST dataset. We will first build a pytorch MLP model with the following default parameters</p>
<div class="highlight"><pre><span></span><span class="n">hparams</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"in_size"</span><span class="p">:</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span> <span class="s2">"hidden_size"</span><span class="p">:</span><span class="mi">128</span><span class="p">,</span> <span class="s2">"out_size"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="s2">"layer_size"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s2">"dropout"</span><span class="p">:</span><span class="mf">0.2</span><span class="p">}</span>
</pre></div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">MLP</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hparams</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">hparams</span><span class="p">[</span><span class="s1">'in_size'</span><span class="p">],</span> <span class="n">hparams</span><span class="p">[</span><span class="s1">'hidden_size'</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">hparams</span><span class="p">[</span><span class="s1">'hidden_size'</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hparams</span><span class="p">[</span><span class="s1">'layer_size'</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">hparams</span><span class="p">[</span><span class="s1">'dropout'</span><span class="p">]))</span>
                
        <span class="n">out_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">hparams</span><span class="p">[</span><span class="s1">'out_size'</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_layer</span><span class="p">)</span>
        
        <span class="c1">##initilize weights</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span>  <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
        
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hparams</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"in_size"</span><span class="p">:</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span> <span class="s2">"hidden_size"</span><span class="p">:</span><span class="mi">128</span><span class="p">,</span> <span class="s2">"out_size"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="s2">"layer_size"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s2">"dropout"</span><span class="p">:</span><span class="mf">0.2</span><span class="p">}</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">hparams</span><span class="p">)</span>
<span class="n">model</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>MLP(
  (mlp): Sequential(
    (0): Linear(in_features=784, out_features=128, bias=True)
    (1): ReLU()
    (2): Linear(in_features=128, out_features=128, bias=True)
    (3): ReLU()
    (4): Dropout(p=0.2, inplace=False)
    (5): Linear(in_features=128, out_features=256, bias=True)
    (6): ReLU()
    (7): Dropout(p=0.2, inplace=False)
    (8): Linear(in_features=256, out_features=512, bias=True)
    (9): ReLU()
    (10): Dropout(p=0.2, inplace=False)
    (11): Linear(in_features=512, out_features=1024, bias=True)
    (12): ReLU()
    (13): Dropout(p=0.2, inplace=False)
    (14): Linear(in_features=1024, out_features=10, bias=True)
  )
)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Pytorch-lightning-model">
<a class="anchor" href="#Pytorch-lightning-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pytorch lightning model<a class="anchor-link" href="#Pytorch-lightning-model"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The key question is how do we pick these parameters. We will use optuna to search optimal parameters that will give us good performance. First we will create a pytorch lightning model which will provides the structure on how to organize the fundamemtal component of any machine learning project. These elements include the arcnitecture or model, data (train, val and test set), model building (train and val step) and evalutaion (test-step). Since we fine defined our MLP, we go ahead and define the data that we will use for this problem.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">random_split</span>
<span class="kn">from</span> <span class="nn">torchvision.datasets</span> <span class="kn">import</span> <span class="n">MNIST</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>
<span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span>  <span class="nn">pytorch_lightning.metrics.functional</span> <span class="k">as</span> <span class="nn">metrics</span>

<span class="k">class</span> <span class="nc">MLPIL</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hparams</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hparams</span> <span class="o">=</span> <span class="n">hparams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">hparams</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">acc</span>  <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">accuracy</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="n">logs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'loss'</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="s2">"tra_acc"</span><span class="p">:</span><span class="n">acc</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">'loss'</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="s1">'log'</span><span class="p">:</span> <span class="n">logs</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">acc</span>  <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">accuracy</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="n">logs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'val_loss'</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="s2">"val_acc"</span><span class="p">:</span><span class="n">acc</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">logs</span>

    <span class="k">def</span> <span class="nf">validation_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="c1"># OPTIONAL</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">avg_acc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s1">'val_acc'</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'avg_val_loss'</span><span class="p">:</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="s2">"avg_val_acc"</span><span class="p">:</span><span class="n">avg_acc</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">'val_loss'</span><span class="p">:</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="s1">'val_acc'</span><span class="p">:</span><span class="n">avg_acc</span><span class="p">,</span> <span class="s1">'log'</span><span class="p">:</span> <span class="n">logs</span><span class="p">}</span>

    
    <span class="k">def</span> <span class="nf">train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># REQUIRED</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">MNIST</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()),</span> 
                                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hparams</span><span class="p">[</span><span class="s2">"batch_size"</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">val_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># OPTIONAL</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">MNIST</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()),</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hparams</span><span class="p">[</span><span class="s2">"batch_size"</span><span class="p">])</span>

    
    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">optimizer</span> <span class="o">=</span>  <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> 
                                         <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hparams</span><span class="p">[</span><span class="s1">'learning_rate'</span><span class="p">],</span> 
                                         <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hparams</span><span class="p">[</span><span class="s1">'momentum'</span><span class="p">],</span> 
                                         <span class="n">nesterov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hparams</span><span class="p">[</span><span class="s1">'nesterov'</span><span class="p">],</span>
                                         <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hparams</span><span class="p">[</span><span class="s1">'weight_decay'</span><span class="p">])</span>    
        
        <span class="k">return</span> <span class="n">optimizer</span>
         
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Define-objective-function">
<a class="anchor" href="#Define-objective-function" aria-hidden="true"><span class="octicon octicon-link"></span></a>Define objective function<a class="anchor-link" href="#Define-objective-function"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DictLogger</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">loggers</span><span class="o">.</span><span class="n">TensorBoardLogger</span><span class="p">):</span>
    <span class="sd">"""PyTorch Lightning `dict` logger."""</span>
    <span class="c1"># see https://github.com/PyTorchLightning/pytorch-lightning/blob/50881c0b31/pytorch_lightning/logging/base.py</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span> 

    <span class="k">def</span> <span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">## Prepare directory</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">optuna.integration</span> <span class="kn">import</span> <span class="n">PyTorchLightningPruningCallback</span>
<span class="n">DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
<span class="n">MODEL_DIR</span> <span class="o">=</span> <span class="n">DIR</span><span class="o">/</span> <span class="s2">"MLP"</span>
<span class="n">MODEL_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"now run `tensorboard --logdir </span><span class="si">{</span><span class="n">MODEL_DIR</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DictLogger</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">loggers</span><span class="o">.</span><span class="n">TensorBoardLogger</span><span class="p">):</span>
    <span class="sd">"""PyTorch Lightning `dict` logger."""</span>
    <span class="c1"># see https://github.com/PyTorchLightning/pytorch-lightning/blob/50881c0b31/pytorch_lightning/logging/base.py</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span> 

    <span class="k">def</span> <span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

<span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"in_size"</span><span class="p">:</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span> <span class="s2">"hidden_size"</span><span class="p">:</span><span class="mi">128</span><span class="p">,</span> <span class="s2">"out_size"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> 
           <span class="s2">"layer_size"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s2">"dropout"</span><span class="p">:</span><span class="mf">0.2</span><span class="p">,</span> <span class="s2">"batch_size"</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span>
          <span class="s1">'learning_rate'</span><span class="p">:</span><span class="mf">1e-3</span><span class="p">,</span> <span class="s1">'momentum'</span><span class="p">:</span><span class="mf">0.9</span><span class="p">,</span> <span class="s1">'nesterov'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
          <span class="s1">'weight_decay'</span><span class="p">:</span><span class="mf">1e-5</span><span class="p">,</span>
          <span class="s1">'epochs'</span><span class="p">:</span><span class="mi">50</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">trial</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lr_param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'learning_rate'</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_loguniform</span><span class="p">(</span><span class="s2">"learning_rate"</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)}</span>
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lr_param</span><span class="p">)</span>
        <span class="n">wdecay_param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'weight_decay'</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_loguniform</span><span class="p">(</span><span class="s1">'weight_decay'</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">)}</span>
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wdecay_param</span><span class="p">)</span>
        <span class="n">hidden_size_param</span><span class="o">=</span><span class="p">{</span><span class="s1">'hidden_size'</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s2">"hidden_size"</span><span class="p">,</span> <span class="p">[</span><span class="mi">8</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)])}</span>
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hidden_size_param</span><span class="p">)</span>
        <span class="n">batch_size_param</span><span class="o">=</span><span class="p">{</span><span class="s1">'hidden_size'</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s2">"batch_size"</span><span class="p">,</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">])}</span>
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hidden_size_param</span><span class="p">)</span>
        <span class="n">layer_size_param</span><span class="o">=</span><span class="p">{</span><span class="s2">"layer_size"</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s2">"layer_size"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)}</span>
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">layer_size_param</span><span class="p">)</span>
        <span class="n">dropout_param</span><span class="o">=</span><span class="p">{</span><span class="s2">"dropout"</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">'dropout'</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)}</span>
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dropout_param</span><span class="p">)</span>
        <span class="n">momentum_param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'momentum'</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">'momentum'</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)}</span>
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">momentum_param</span><span class="p">)</span>
        <span class="n">nest_param</span><span class="o">=</span><span class="p">{</span><span class="s1">'nesterov'</span><span class="p">:</span><span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s2">"nesterov"</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">])}</span>
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nest_param</span><span class="p">)</span>
        <span class="n">early_stopping</span> <span class="o">=</span> <span class="n">PyTorchLightningPruningCallback</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="s1">'val_acc'</span><span class="p">)</span>
        <span class="n">checkpoint_callback</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_DIR</span><span class="p">,</span> <span class="s2">"trial_</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trial</span><span class="o">.</span><span class="n">number</span><span class="p">)),</span> <span class="n">monitor</span><span class="o">=</span><span class="s2">"val_acc"</span>
    <span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">DictLogger</span><span class="p">(</span><span class="n">MODEL_DIR</span><span class="p">,</span>  <span class="n">version</span><span class="o">=</span><span class="n">trial</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">early_stopping</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">'val_acc'</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"max"</span><span class="p">)</span>  
        <span class="n">logger</span> <span class="o">=</span> <span class="n">DictLogger</span><span class="p">(</span><span class="n">MODEL_DIR</span><span class="p">)</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
                    <span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">,</span>
                    <span class="n">checkpoint_callback</span><span class="o">=</span><span class="n">checkpoint_callback</span><span class="p">,</span>
                    <span class="n">max_epochs</span><span class="o">=</span><span class="n">default_params</span><span class="p">[</span><span class="s1">'epochs'</span><span class="p">],</span>
                    <span class="n">gpus</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">early_stop_callback</span><span class="o">=</span><span class="n">early_stopping</span><span class="p">,</span>
                    <span class="n">accumulate_grad_batches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">benchmark</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">MLPIL</span><span class="p">(</span><span class="n">default_params</span><span class="p">)</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">logger</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">'val_acc'</span><span class="p">]</span>

    
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>now run `tensorboard --logdir /Users/sambaiga/Documents/sambaiga/_notebooks/MLP
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">optuna</span>
<span class="k">def</span> <span class="nf">run_study</span><span class="p">(</span><span class="n">num_trials</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">'maximize'</span><span class="p">)</span>
    <span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="n">num_trials</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">study</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">study</span> <span class="o">=</span> <span class="n">run_study</span><span class="p">(</span><span class="n">num_trials</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>GPU available: False, used: False
TPU available: False, using: 0 TPU cores

  | Name  | Type | Params
-------------------------------
0 | model | MLP  | 3 M   
/usr/local/lib/python3.7/site-packages/pytorch_lightning/utilities/distributed.py:25: UserWarning: The dataloader, val dataloader 0, does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` (try 4 which is the number of cpus on this machine) in the `DataLoader` init to improve performance.
  warnings.warn(*args, **kwargs)
/usr/local/lib/python3.7/site-packages/pytorch_lightning/utilities/distributed.py:25: UserWarning: The dataloader, train dataloader, does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` (try 4 which is the number of cpus on this machine) in the `DataLoader` init to improve performance.
  warnings.warn(*args, **kwargs)
/usr/local/lib/python3.7/site-packages/pytorch_lightning/utilities/distributed.py:25: UserWarning: Detected KeyboardInterrupt, attempting graceful shutdown...
  warnings.warn(*args, **kwargs)
<span class="ansi-yellow-fg">[W 2020-06-21 11:52:45,679]</span> Setting status of trial#0 as TrialState.FAIL because of the following error: KeyError('val_acc')
Traceback (most recent call last):
  File "/usr/local/lib/python3.7/site-packages/optuna/study.py", line 732, in _run_trial
    result = func(trial)
  File "&lt;ipython-input-47-7c6150fb2720&gt;", line 66, in objective
    return logger.metrics[-1]['val_acc']
KeyError: 'val_acc'
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyError</span>                                  Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-49-24f479b1d5cc&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>study <span class="ansi-blue-fg">=</span> run_study<span class="ansi-blue-fg">(</span>num_trials<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-48-07ccf7fd8392&gt;</span> in <span class="ansi-cyan-fg">run_study</span><span class="ansi-blue-fg">(num_trials)</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> <span class="ansi-green-fg">def</span> run_study<span class="ansi-blue-fg">(</span>num_trials<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span>     study <span class="ansi-blue-fg">=</span> optuna<span class="ansi-blue-fg">.</span>create_study<span class="ansi-blue-fg">(</span>direction<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">'maximize'</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">----&gt; 4</span><span class="ansi-red-fg">     </span>study<span class="ansi-blue-fg">.</span>optimize<span class="ansi-blue-fg">(</span>objective<span class="ansi-blue-fg">,</span> n_trials<span class="ansi-blue-fg">=</span>num_trials<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span>     <span class="ansi-green-fg">return</span> study

<span class="ansi-green-fg">/usr/local/lib/python3.7/site-packages/optuna/study.py</span> in <span class="ansi-cyan-fg">optimize</span><span class="ansi-blue-fg">(self, func, n_trials, timeout, n_jobs, catch, callbacks, gc_after_trial, show_progress_bar)</span>
<span class="ansi-green-intense-fg ansi-bold">    332</span>             <span class="ansi-green-fg">if</span> n_jobs <span class="ansi-blue-fg">==</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    333</span>                 self._optimize_sequential(
<span class="ansi-green-fg">--&gt; 334</span><span class="ansi-red-fg">                     </span>func<span class="ansi-blue-fg">,</span> n_trials<span class="ansi-blue-fg">,</span> timeout<span class="ansi-blue-fg">,</span> catch<span class="ansi-blue-fg">,</span> callbacks<span class="ansi-blue-fg">,</span> gc_after_trial<span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span>
<span class="ansi-green-intense-fg ansi-bold">    335</span>                 )
<span class="ansi-green-intense-fg ansi-bold">    336</span>             <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">/usr/local/lib/python3.7/site-packages/optuna/study.py</span> in <span class="ansi-cyan-fg">_optimize_sequential</span><span class="ansi-blue-fg">(self, func, n_trials, timeout, catch, callbacks, gc_after_trial, time_start)</span>
<span class="ansi-green-intense-fg ansi-bold">    675</span>                     <span class="ansi-green-fg">break</span>
<span class="ansi-green-intense-fg ansi-bold">    676</span> 
<span class="ansi-green-fg">--&gt; 677</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>_run_trial_and_callbacks<span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">,</span> catch<span class="ansi-blue-fg">,</span> callbacks<span class="ansi-blue-fg">,</span> gc_after_trial<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    678</span> 
<span class="ansi-green-intense-fg ansi-bold">    679</span>             self<span class="ansi-blue-fg">.</span>_progress_bar<span class="ansi-blue-fg">.</span>update<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">(</span>datetime<span class="ansi-blue-fg">.</span>datetime<span class="ansi-blue-fg">.</span>now<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-</span> time_start<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>total_seconds<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/usr/local/lib/python3.7/site-packages/optuna/study.py</span> in <span class="ansi-cyan-fg">_run_trial_and_callbacks</span><span class="ansi-blue-fg">(self, func, catch, callbacks, gc_after_trial)</span>
<span class="ansi-green-intense-fg ansi-bold">    706</span>         <span class="ansi-red-fg"># type: (...) -&gt; None</span>
<span class="ansi-green-intense-fg ansi-bold">    707</span> 
<span class="ansi-green-fg">--&gt; 708</span><span class="ansi-red-fg">         </span>trial <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_run_trial<span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">,</span> catch<span class="ansi-blue-fg">,</span> gc_after_trial<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    709</span>         <span class="ansi-green-fg">if</span> callbacks <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    710</span>             frozen_trial <span class="ansi-blue-fg">=</span> copy<span class="ansi-blue-fg">.</span>deepcopy<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_storage<span class="ansi-blue-fg">.</span>get_trial<span class="ansi-blue-fg">(</span>trial<span class="ansi-blue-fg">.</span>_trial_id<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/usr/local/lib/python3.7/site-packages/optuna/study.py</span> in <span class="ansi-cyan-fg">_run_trial</span><span class="ansi-blue-fg">(self, func, catch, gc_after_trial)</span>
<span class="ansi-green-intense-fg ansi-bold">    730</span> 
<span class="ansi-green-intense-fg ansi-bold">    731</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 732</span><span class="ansi-red-fg">             </span>result <span class="ansi-blue-fg">=</span> func<span class="ansi-blue-fg">(</span>trial<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    733</span>         <span class="ansi-green-fg">except</span> exceptions<span class="ansi-blue-fg">.</span>TrialPruned <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    734</span>             message = "Setting status of trial#{} as {}. {}".format(

<span class="ansi-green-fg">&lt;ipython-input-47-7c6150fb2720&gt;</span> in <span class="ansi-cyan-fg">objective</span><span class="ansi-blue-fg">(trial)</span>
<span class="ansi-green-intense-fg ansi-bold">     64</span>     trainer<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span>model<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     65</span>     <span class="ansi-green-fg">if</span> trial <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 66</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> logger<span class="ansi-blue-fg">.</span>metrics<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">'val_acc'</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">     67</span> 
<span class="ansi-green-intense-fg ansi-bold">     68</span> 

<span class="ansi-red-fg">KeyError</span>: 'val_acc'</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">MLPIL</span><span class="p">(</span><span class="n">default_params</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">()))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="sambaiga/sambaiga"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/sambaiga/machine%20learning/deep%20learning/2020/06/22/hyper-search.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer">

  <div class="wrapper">
<div class="wrapper">
     Copyright 2020 
    
    
    : sambaiga@gmail.com
  </div>

  </div>
</footer>



<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="/assets/js/common.js"></script>

<script>
  $("script[type='math/tex']").replaceWith(function() {
      var tex = $(this).text();
      return katex.renderToString(tex.replace(/%.*/g, ''), {displayMode: false});
  });

  $("script[type='math/tex; mode=display']").replaceWith(function() {
      var tex = $(this).html();
      return katex.renderToString(tex.replace(/%.*/g, ''), {displayMode: true});
  });
</script>


</body>

</html>
